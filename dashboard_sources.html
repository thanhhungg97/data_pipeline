<!doctype html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Multi-Source Comparison Dashboard</title>
        <!-- Bootstrap 5 -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <!-- Tom Select for multi-select -->
        <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
        <!-- Plotly -->
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
        <style>
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
            }
            .nav-pills .nav-link {
                color: #888;
            }
            .nav-pills .nav-link.active {
                background-color: #00d4aa;
            }
            .card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .form-select, .ts-wrapper .ts-control {
                background: rgba(255, 255, 255, 0.1) !important;
                border-color: rgba(255, 255, 255, 0.2) !important;
                color: #fff !important;
            }
            .ts-wrapper .ts-control input { color: #fff !important; }
            .ts-dropdown { background: #1a1a2e !important; border-color: rgba(255,255,255,0.2) !important; }
            .ts-dropdown .option { color: #fff; }
            .ts-dropdown .option:hover, .ts-dropdown .active { background: rgba(0,212,170,0.2) !important; }
            .ts-wrapper.multi .ts-control > .item {
                background: #00d4aa !important;
                border: none !important;
                color: #fff !important;
            }
            .text-success { color: #00d4aa !important; }
            .text-danger { color: #ff6b6b !important; }
            .table { color: #e0e0e0; }
            .table thead th { 
                background: rgba(255,255,255,0.05); 
                border-color: rgba(255,255,255,0.1);
                text-transform: uppercase;
                font-size: 12px;
                letter-spacing: 1px;
            }
            .table td { border-color: rgba(255,255,255,0.1); }
            .best { color: #00d4aa; font-weight: 600; }
            .color-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
            }
        </style>
    </head>
    <body>
        <!-- Navigation -->
        <nav class="navbar navbar-dark bg-dark bg-opacity-50 border-bottom border-secondary">
            <div class="container-fluid">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">üìä Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard_compare.html">üìà Monthly Compare</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard_sources.html">üè™ Sources</a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="text-white">üè™ Multi-Source Comparison Dashboard</h1>
                <p class="text-secondary">Compare performance across different sales channels</p>
            </div>

            <!-- Controls -->
            <div class="row g-3 mb-4">
                <div class="col-auto">
                    <label class="form-label text-secondary small text-uppercase">Select Month</label>
                    <select id="monthSelector" class="form-select"></select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-secondary small text-uppercase">Compare Sources</label>
                    <select id="sourceSelector" multiple placeholder="Select sources..."></select>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row g-3 mb-4" id="summaryGrid"></div>

            <!-- Charts -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-white">üìà Orders by Source Over Time</h5>
                            <div id="trendChart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-white">üìä Source Comparison (Selected Month)</h5>
                            <div id="comparisonChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Table -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-white mb-3">üìã Detailed Comparison</h5>
                    <div class="table-responsive">
                        <table class="table table-hover" id="comparisonTable">
                            <thead>
                                <tr><th>Metric</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Tom Select -->
        <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

        <script>
            const metricsData = [{"Source": "Shopee", "Year": 2024, "Month": 1, "total_orders": 8742, "delivered": 5726, "cancelled": 2508, "returned": 246, "failed": 262, "delivery_rate": 65.5, "cancel_rate": 28.7}, {"Source": "Shopee", "Year": 2024, "Month": 2, "total_orders": 5988, "delivered": 4042, "cancelled": 1562, "returned": 170, "failed": 214, "delivery_rate": 67.5, "cancel_rate": 26.1}, {"Source": "Shopee", "Year": 2024, "Month": 3, "total_orders": 11846, "delivered": 7460, "cancelled": 3602, "returned": 526, "failed": 258, "delivery_rate": 63.0, "cancel_rate": 30.4}, {"Source": "Shopee", "Year": 2024, "Month": 4, "total_orders": 13540, "delivered": 8446, "cancelled": 4008, "returned": 730, "failed": 356, "delivery_rate": 62.4, "cancel_rate": 29.6}, {"Source": "Shopee", "Year": 2024, "Month": 5, "total_orders": 27816, "delivered": 17630, "cancelled": 8050, "returned": 1502, "failed": 634, "delivery_rate": 63.4, "cancel_rate": 28.9}, {"Source": "Shopee", "Year": 2024, "Month": 6, "total_orders": 23852, "delivered": 14742, "cancelled": 6928, "returned": 1608, "failed": 574, "delivery_rate": 61.8, "cancel_rate": 29.0}, {"Source": "Shopee", "Year": 2024, "Month": 7, "total_orders": 26066, "delivered": 16506, "cancelled": 7050, "returned": 1802, "failed": 708, "delivery_rate": 63.3, "cancel_rate": 27.0}, {"Source": "Shopee", "Year": 2024, "Month": 8, "total_orders": 28700, "delivered": 19890, "cancelled": 7820, "returned": 328, "failed": 662, "delivery_rate": 69.3, "cancel_rate": 27.2}, {"Source": "Shopee", "Year": 2024, "Month": 9, "total_orders": 33226, "delivered": 22410, "cancelled": 9672, "returned": 410, "failed": 734, "delivery_rate": 67.4, "cancel_rate": 29.1}, {"Source": "Shopee", "Year": 2024, "Month": 10, "total_orders": 24328, "delivered": 15564, "cancelled": 6548, "returned": 1640, "failed": 576, "delivery_rate": 64.0, "cancel_rate": 26.9}, {"Source": "Shopee", "Year": 2024, "Month": 11, "total_orders": 30890, "delivered": 18898, "cancelled": 8526, "returned": 3426, "failed": 40, "delivery_rate": 61.2, "cancel_rate": 27.6}, {"Source": "Shopee", "Year": 2024, "Month": 12, "total_orders": 22220, "delivered": 13776, "cancelled": 6138, "returned": 2272, "failed": 34, "delivery_rate": 62.0, "cancel_rate": 27.6}, {"Source": "Shopee", "Year": 2025, "Month": 1, "total_orders": 16512, "delivered": 10560, "cancelled": 4542, "returned": 1050, "failed": 360, "delivery_rate": 64.0, "cancel_rate": 27.5}, {"Source": "Shopee", "Year": 2025, "Month": 2, "total_orders": 14756, "delivered": 9572, "cancelled": 4074, "returned": 780, "failed": 330, "delivery_rate": 64.9, "cancel_rate": 27.6}, {"Source": "Shopee", "Year": 2025, "Month": 3, "total_orders": 17424, "delivered": 11222, "cancelled": 4934, "returned": 1000, "failed": 268, "delivery_rate": 64.4, "cancel_rate": 28.3}, {"Source": "Shopee", "Year": 2025, "Month": 4, "total_orders": 18968, "delivered": 12148, "cancelled": 5250, "returned": 1182, "failed": 388, "delivery_rate": 64.0, "cancel_rate": 27.7}, {"Source": "Shopee", "Year": 2025, "Month": 5, "total_orders": 29252, "delivered": 18416, "cancelled": 8532, "returned": 1704, "failed": 600, "delivery_rate": 63.0, "cancel_rate": 29.2}, {"Source": "Shopee", "Year": 2025, "Month": 6, "total_orders": 37554, "delivered": 23952, "cancelled": 10098, "returned": 2758, "failed": 746, "delivery_rate": 63.8, "cancel_rate": 26.9}, {"Source": "Shopee", "Year": 2025, "Month": 7, "total_orders": 35396, "delivered": 23056, "cancelled": 8892, "returned": 2818, "failed": 630, "delivery_rate": 65.1, "cancel_rate": 25.1}, {"Source": "Shopee", "Year": 2025, "Month": 8, "total_orders": 29616, "delivered": 19388, "cancelled": 7426, "returned": 2214, "failed": 588, "delivery_rate": 65.5, "cancel_rate": 25.1}, {"Source": "Shopee", "Year": 2025, "Month": 9, "total_orders": 28762, "delivered": 17648, "cancelled": 8064, "returned": 2522, "failed": 528, "delivery_rate": 61.4, "cancel_rate": 28.0}, {"Source": "Shopee", "Year": 2025, "Month": 10, "total_orders": 30016, "delivered": 18454, "cancelled": 8568, "returned": 2446, "failed": 548, "delivery_rate": 61.5, "cancel_rate": 28.5}, {"Source": "Shopee", "Year": 2025, "Month": 11, "total_orders": 44298, "delivered": 25962, "cancelled": 13060, "returned": 2958, "failed": 596, "delivery_rate": 58.6, "cancel_rate": 29.5}, {"Source": "Website_Columbia", "Year": 2025, "Month": 5, "total_orders": 88, "delivered": 50, "cancelled": 30, "returned": 2, "failed": 6, "delivery_rate": 56.8, "cancel_rate": 34.1}, {"Source": "Website_Columbia", "Year": 2025, "Month": 6, "total_orders": 110, "delivered": 90, "cancelled": 6, "returned": 0, "failed": 14, "delivery_rate": 81.8, "cancel_rate": 5.5}, {"Source": "Website_Columbia", "Year": 2025, "Month": 7, "total_orders": 350, "delivered": 266, "cancelled": 18, "returned": 12, "failed": 54, "delivery_rate": 76.0, "cancel_rate": 5.1}, {"Source": "Website_Columbia", "Year": 2025, "Month": 8, "total_orders": 414, "delivered": 350, "cancelled": 4, "returned": 18, "failed": 42, "delivery_rate": 84.5, "cancel_rate": 1.0}, {"Source": "Website_Columbia", "Year": 2025, "Month": 9, "total_orders": 700, "delivered": 560, "cancelled": 36, "returned": 16, "failed": 88, "delivery_rate": 80.0, "cancel_rate": 5.1}, {"Source": "Website_Columbia", "Year": 2025, "Month": 10, "total_orders": 666, "delivered": 506, "cancelled": 50, "returned": 42, "failed": 68, "delivery_rate": 76.0, "cancel_rate": 7.5}, {"Source": "Website_Columbia", "Year": 2025, "Month": 11, "total_orders": 724, "delivered": 520, "cancelled": 46, "returned": 34, "failed": 64, "delivery_rate": 71.8, "cancel_rate": 6.4}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 1, "total_orders": 11368, "delivered": 9050, "cancelled": 808, "returned": 582, "failed": 928, "delivery_rate": 79.6, "cancel_rate": 7.1}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 2, "total_orders": 8446, "delivered": 6626, "cancelled": 548, "returned": 390, "failed": 882, "delivery_rate": 78.5, "cancel_rate": 6.5}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 3, "total_orders": 11872, "delivered": 9466, "cancelled": 762, "returned": 668, "failed": 976, "delivery_rate": 79.7, "cancel_rate": 6.4}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 4, "total_orders": 14960, "delivered": 12274, "cancelled": 612, "returned": 852, "failed": 1222, "delivery_rate": 82.0, "cancel_rate": 4.1}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 5, "total_orders": 13784, "delivered": 11320, "cancelled": 590, "returned": 804, "failed": 1070, "delivery_rate": 82.1, "cancel_rate": 4.3}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 6, "total_orders": 16400, "delivered": 13482, "cancelled": 634, "returned": 810, "failed": 1474, "delivery_rate": 82.2, "cancel_rate": 3.9}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 7, "total_orders": 14562, "delivered": 11862, "cancelled": 1024, "returned": 584, "failed": 1092, "delivery_rate": 81.5, "cancel_rate": 7.0}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 8, "total_orders": 14224, "delivered": 11366, "cancelled": 1160, "returned": 694, "failed": 1004, "delivery_rate": 79.9, "cancel_rate": 8.2}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 9, "total_orders": 14960, "delivered": 11924, "cancelled": 1178, "returned": 750, "failed": 1108, "delivery_rate": 79.7, "cancel_rate": 7.9}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 10, "total_orders": 14142, "delivered": 11858, "cancelled": 918, "returned": 776, "failed": 580, "delivery_rate": 83.8, "cancel_rate": 6.5}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 11, "total_orders": 17030, "delivered": 13820, "cancelled": 1094, "returned": 966, "failed": 1150, "delivery_rate": 81.2, "cancel_rate": 6.4}, {"Source": "Website_Suppersport", "Year": 2024, "Month": 12, "total_orders": 13952, "delivered": 11248, "cancelled": 930, "returned": 724, "failed": 1050, "delivery_rate": 80.6, "cancel_rate": 6.7}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 1, "total_orders": 12090, "delivered": 9424, "cancelled": 1032, "returned": 626, "failed": 1008, "delivery_rate": 77.9, "cancel_rate": 8.5}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 2, "total_orders": 11214, "delivered": 8912, "cancelled": 822, "returned": 608, "failed": 872, "delivery_rate": 79.5, "cancel_rate": 7.3}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 3, "total_orders": 13604, "delivered": 10584, "cancelled": 946, "returned": 770, "failed": 1194, "delivery_rate": 77.8, "cancel_rate": 7.0}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 4, "total_orders": 13604, "delivered": 10340, "cancelled": 1088, "returned": 652, "failed": 1044, "delivery_rate": 76.0, "cancel_rate": 8.0}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 5, "total_orders": 13952, "delivered": 11196, "cancelled": 568, "returned": 674, "failed": 1258, "delivery_rate": 80.2, "cancel_rate": 4.1}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 6, "total_orders": 13342, "delivered": 10878, "cancelled": 790, "returned": 490, "failed": 1172, "delivery_rate": 81.5, "cancel_rate": 5.9}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 7, "total_orders": 15844, "delivered": 11520, "cancelled": 1092, "returned": 736, "failed": 1538, "delivery_rate": 72.7, "cancel_rate": 6.9}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 8, "total_orders": 13102, "delivered": 9918, "cancelled": 854, "returned": 496, "failed": 1342, "delivery_rate": 75.7, "cancel_rate": 6.5}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 9, "total_orders": 21614, "delivered": 15850, "cancelled": 1330, "returned": 1154, "failed": 2748, "delivery_rate": 73.3, "cancel_rate": 6.2}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 10, "total_orders": 15052, "delivered": 10956, "cancelled": 898, "returned": 726, "failed": 1834, "delivery_rate": 72.8, "cancel_rate": 6.0}, {"Source": "Website_Suppersport", "Year": 2025, "Month": 11, "total_orders": 22712, "delivered": 15914, "cancelled": 1600, "returned": 968, "failed": 2590, "delivery_rate": 70.1, "cancel_rate": 7.0}, {"Source": "Website_Underamour", "Year": 2025, "Month": 3, "total_orders": 476, "delivered": 304, "cancelled": 10, "returned": 8, "failed": 44, "delivery_rate": 63.9, "cancel_rate": 2.1}, {"Source": "Website_Underamour", "Year": 2025, "Month": 4, "total_orders": 1964, "delivered": 1182, "cancelled": 64, "returned": 50, "failed": 188, "delivery_rate": 60.2, "cancel_rate": 3.3}, {"Source": "Website_Underamour", "Year": 2025, "Month": 5, "total_orders": 2384, "delivered": 1720, "cancelled": 92, "returned": 78, "failed": 238, "delivery_rate": 72.1, "cancel_rate": 3.9}, {"Source": "Website_Underamour", "Year": 2025, "Month": 6, "total_orders": 3658, "delivered": 3106, "cancelled": 110, "returned": 2, "failed": 428, "delivery_rate": 84.9, "cancel_rate": 3.0}, {"Source": "Website_Underamour", "Year": 2025, "Month": 7, "total_orders": 6296, "delivered": 4164, "cancelled": 278, "returned": 246, "failed": 650, "delivery_rate": 66.1, "cancel_rate": 4.4}, {"Source": "Website_Underamour", "Year": 2025, "Month": 8, "total_orders": 4598, "delivered": 3194, "cancelled": 244, "returned": 126, "failed": 542, "delivery_rate": 69.5, "cancel_rate": 5.3}, {"Source": "Website_Underamour", "Year": 2025, "Month": 9, "total_orders": 5196, "delivered": 3510, "cancelled": 360, "returned": 184, "failed": 618, "delivery_rate": 67.6, "cancel_rate": 6.9}, {"Source": "Website_Underamour", "Year": 2025, "Month": 10, "total_orders": 5944, "delivered": 4010, "cancelled": 454, "returned": 196, "failed": 656, "delivery_rate": 67.5, "cancel_rate": 7.6}, {"Source": "Website_Underamour", "Year": 2025, "Month": 11, "total_orders": 7804, "delivered": 4978, "cancelled": 716, "returned": 234, "failed": 904, "delivery_rate": 63.8, "cancel_rate": 9.2}];
            const allSources = ["Shopee", "Website_Columbia", "Website_Suppersport", "Website_Underamour"];
            let selectedSources = [...allSources];

            // Color palette
            const colorPalette = [
                '#ee4d2d', '#00d4aa', '#ff6b9d', '#ffa726', '#42a5f5',
                '#ab47bc', '#26a69a', '#ef5350', '#7e57c2', '#66bb6a'
            ];
            const sourceColors = {};
            allSources.forEach((source, i) => {
                sourceColors[source] = colorPalette[i % colorPalette.length];
            });

            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const periods = [...new Set(metricsData.map(d => `${d.Year}-${d.Month}`))].sort().reverse();

            // Populate month selector
            const monthSelect = document.getElementById('monthSelector');
            periods.forEach((p, i) => {
                const [year, month] = p.split('-').map(Number);
                const opt = new Option(`${monthNames[month]} ${year}`, p, i === 0, i === 0);
                monthSelect.add(opt);
            });
            monthSelect.onchange = updateDashboard;

            // Initialize Tom Select for sources
            const sourceSelect = new TomSelect('#sourceSelector', {
                plugins: ['remove_button', 'checkbox_options'],
                maxItems: null,
                valueField: 'value',
                labelField: 'label',
                searchField: 'label',
                options: allSources.map(s => ({
                    value: s,
                    label: s,
                    color: sourceColors[s]
                })),
                items: allSources,
                render: {
                    option: function(data, escape) {
                        return `<div><span class="color-dot" style="background:${data.color}"></span>${escape(data.label)}</div>`;
                    },
                    item: function(data, escape) {
                        return `<div style="background:${data.color}">${escape(data.label)}</div>`;
                    }
                },
                onChange: function(values) {
                    selectedSources = values.length > 0 ? values : [allSources[0]];
                    if (values.length === 0) {
                        this.addItem(allSources[0]);
                    }
                    updateDashboard();
                }
            });

            function getSourceData(source, year, month) {
                return metricsData.find(d => d.Source === source && d.Year === year && d.Month === month);
            }

            function fmt(n) { return n ? n.toLocaleString() : '0'; }

            function updateDashboard() {
                const [year, month] = monthSelect.value.split('-').map(Number);
                const grid = document.getElementById('summaryGrid');
                grid.innerHTML = '';

                selectedSources.forEach(source => {
                    const data = getSourceData(source, year, month);
                    const color = sourceColors[source];
                    grid.innerHTML += `
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-3" style="color:${color}">
                                        <span class="color-dot" style="background:${color}"></span>
                                        ${source}
                                    </h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-secondary">Total Orders</span>
                                        <span class="text-white fw-bold">${data ? fmt(data.total_orders) : '-'}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-secondary">Delivery Rate</span>
                                        <span class="text-success fw-bold">${data ? data.delivery_rate + '%' : '-'}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-secondary">Cancel Rate</span>
                                        <span class="text-danger fw-bold">${data ? data.cancel_rate + '%' : '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                updateCharts(year, month);
                updateComparisonTable(year, month);
            }

            function updateCharts(year, month) {
                const traces = selectedSources.map(source => {
                    const sourceData = metricsData.filter(d => d.Source === source)
                        .sort((a, b) => a.Year !== b.Year ? a.Year - b.Year : a.Month - b.Month).slice(-12);
                    return {
                        x: sourceData.map(d => `${monthNames[d.Month]} ${d.Year}`),
                        y: sourceData.map(d => d.total_orders),
                        type: 'scatter', mode: 'lines+markers', name: source,
                        line: {color: sourceColors[source], width: 3}
                    };
                });

                Plotly.newPlot('trendChart', traces, {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: {color: '#888'}, margin: {t: 20, r: 20, b: 60, l: 60},
                    xaxis: {gridcolor: 'rgba(255,255,255,0.1)', tickangle: -45},
                    yaxis: {gridcolor: 'rgba(255,255,255,0.1)', title: 'Orders'},
                    legend: {orientation: 'h', y: 1.1}
                }, {responsive: true});

                const metrics = ['Total Orders', 'Delivered', 'Cancelled', 'Returned'];
                const barTraces = selectedSources.map(source => {
                    const data = getSourceData(source, year, month);
                    return {
                        x: metrics,
                        y: data ? [data.total_orders, data.delivered, data.cancelled, data.returned] : [0,0,0,0],
                        type: 'bar', name: source,
                        marker: {color: sourceColors[source]}
                    };
                });

                Plotly.newPlot('comparisonChart', barTraces, {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: {color: '#888'}, margin: {t: 20, r: 20, b: 40, l: 60},
                    barmode: 'group', legend: {orientation: 'h', y: 1.15},
                    yaxis: {gridcolor: 'rgba(255,255,255,0.1)'}
                }, {responsive: true});
            }

            function updateComparisonTable(year, month) {
                const table = document.getElementById('comparisonTable');
                const thead = table.querySelector('thead tr');
                const tbody = table.querySelector('tbody');

                thead.innerHTML = '<th>Metric</th>' + selectedSources.map(s =>
                    `<th><span class="color-dot" style="background:${sourceColors[s]}"></span>${s}</th>`
                ).join('');

                const sourceData = selectedSources.map(s => getSourceData(s, year, month) || {});
                const rows = [
                    {label: 'Total Orders', key: 'total_orders', best: 'max'},
                    {label: 'Delivered', key: 'delivered', best: 'max'},
                    {label: 'Delivery Rate', key: 'delivery_rate', best: 'max', suffix: '%'},
                    {label: 'Cancelled', key: 'cancelled', best: 'min'},
                    {label: 'Cancel Rate', key: 'cancel_rate', best: 'min', suffix: '%'},
                    {label: 'Returned', key: 'returned', best: 'min'},
                ];

                tbody.innerHTML = rows.map(row => {
                    const values = sourceData.map(d => d[row.key] || 0);
                    const best = row.best === 'max' ? Math.max(...values) : Math.min(...values.filter(v => v > 0));
                    return `<tr><td>${row.label}</td>${values.map(v =>
                        `<td class="${v === best && v > 0 ? 'best' : ''}">${fmt(v)}${row.suffix || ''}</td>`
                    ).join('')}</tr>`;
                }).join('');
            }

            updateDashboard();
        </script>
    </body>
</html>

<!doctype html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Monthly Comparison Dashboard</title>
        <!-- Bootstrap 5 -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <!-- Plotly -->
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
        <style>
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
            }
            .nav-pills .nav-link { color: #888; }
            .nav-pills .nav-link.active { background-color: #00d4aa; }
            .card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .text-success { color: #00d4aa !important; }
            .text-danger { color: #ff6b6b !important; }
            .text-warning { color: #ffa726 !important; }
            .text-purple { color: #ab47bc !important; }
            .stat-value { font-size: 2.5rem; font-weight: 700; }
            .stat-label { font-size: 0.875rem; color: #888; text-transform: uppercase; }
            .comparison-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 0.875rem;
                font-weight: 500;
            }
            .comparison-badge.up { background: rgba(0,212,170,0.2); color: #00d4aa; }
            .comparison-badge.down { background: rgba(255,107,107,0.2); color: #ff6b6b; }
            .comparison-badge.neutral { background: rgba(136,136,136,0.2); color: #888; }
        </style>
    </head>
    <body>
        <!-- Navigation -->
        <nav class="navbar navbar-dark bg-dark bg-opacity-50 border-bottom border-secondary">
            <div class="container-fluid">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">üìä Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard_compare.html">üìà Monthly Compare</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard_sources.html">üè™ Sources</a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="text-white">üìà Monthly Comparison Dashboard</h1>
                <p class="text-secondary">Compare current month with previous month and year-over-year</p>
            </div>

            <!-- Controls -->
            <div class="row g-3 mb-4">
                <div class="col-auto">
                    <label class="form-label text-secondary small text-uppercase">Source</label>
                    <select id="sourceSelector" class="form-select"></select>
                </div>
                <div class="col-auto">
                    <label class="form-label text-secondary small text-uppercase">Month</label>
                    <select id="monthSelector" class="form-select"></select>
                </div>
            </div>

            <!-- Main Metrics with Comparisons -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="stat-label">Total Orders</div>
                            <div class="stat-value text-white" id="totalOrders">-</div>
                            <div class="mt-3 d-flex gap-3">
                                <div>
                                    <small class="text-secondary d-block">vs Last Month</small>
                                    <span id="totalVsLastMonth">-</span>
                                </div>
                                <div>
                                    <small class="text-secondary d-block">vs Last Year</small>
                                    <span id="totalVsLastYear">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="stat-label">Delivery Rate</div>
                            <div class="stat-value text-success" id="deliveryRate">-</div>
                            <div class="mt-3 d-flex gap-3">
                                <div>
                                    <small class="text-secondary d-block">vs Last Month</small>
                                    <span id="deliveryVsLastMonth">-</span>
                                </div>
                                <div>
                                    <small class="text-secondary d-block">vs Last Year</small>
                                    <span id="deliveryVsLastYear">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="stat-label">Cancellation Rate</div>
                            <div class="stat-value text-danger" id="cancelRate">-</div>
                            <div class="mt-3 d-flex gap-3">
                                <div>
                                    <small class="text-secondary d-block">vs Last Month</small>
                                    <span id="cancelVsLastMonth">-</span>
                                </div>
                                <div>
                                    <small class="text-secondary d-block">vs Last Year</small>
                                    <span id="cancelVsLastYear">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Breakdown -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-secondary mb-2">‚úÖ Delivered</h6>
                            <span class="fs-3 fw-bold text-success" id="deliveredPct">-</span>
                            <span class="text-secondary ms-2" id="deliveredCount">-</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-secondary mb-2">‚ùå Cancelled</h6>
                            <span class="fs-3 fw-bold text-danger" id="cancelledPct">-</span>
                            <span class="text-secondary ms-2" id="cancelledCount">-</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-secondary mb-2">‚Ü©Ô∏è Returned</h6>
                            <span class="fs-3 fw-bold text-warning" id="returnedPct">-</span>
                            <span class="text-secondary ms-2" id="returnedCount">-</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-secondary mb-2">‚ö†Ô∏è Failed</h6>
                            <span class="fs-3 fw-bold text-purple" id="failedPct">-</span>
                            <span class="text-secondary ms-2" id="failedCount">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row g-3">
                <div class="col-md-7">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-white">üìà Orders Trend (12 Months)</h5>
                            <div id="trendChart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-white">üìä 3-Month Comparison</h5>
                            <div id="comparisonChart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const allData = {{DATA}};
            const allSources = {{SOURCES}};
            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Populate source selector
            const sourceSelector = document.getElementById('sourceSelector');
            sourceSelector.add(new Option('üìä All Sources', 'All'));
            allSources.forEach(s => sourceSelector.add(new Option(s, s)));
            sourceSelector.onchange = updateDashboard;

            function getFilteredData() {
                const source = sourceSelector.value;
                return source === 'All' 
                    ? allData.filter(d => d.Source === 'All')
                    : allData.filter(d => d.Source === source);
            }

            function updateMonthSelector() {
                const data = getFilteredData();
                data.sort((a, b) => a.Year !== b.Year ? a.Year - b.Year : a.Month - b.Month);

                const monthSelector = document.getElementById('monthSelector');
                const currentValue = monthSelector.value;
                monthSelector.innerHTML = '';

                [...data].reverse().forEach((d, i) => {
                    const opt = new Option(`${monthNames[d.Month]} ${d.Year}`, `${d.Year}-${d.Month}`);
                    if (opt.value === currentValue || i === 0) opt.selected = true;
                    monthSelector.add(opt);
                });
            }

            function getMonthData(year, month) {
                return getFilteredData().find(d => d.Year === year && d.Month === month);
            }

            function getLastMonth(year, month) {
                return month === 1 ? { year: year - 1, month: 12 } : { year, month: month - 1 };
            }

            function fmt(n) { return n ? n.toLocaleString() : '0'; }

            function formatChange(current, previous, isRate = false) {
                if (!previous || previous === 0) return '<span class="comparison-badge neutral">N/A</span>';
                const change = isRate ? (current - previous).toFixed(1) : (((current - previous) / previous) * 100).toFixed(1);
                const isPositive = change > 0;
                const cls = isRate ? (isPositive ? 'down' : 'up') : (isPositive ? 'up' : 'down');
                return `<span class="comparison-badge ${cls}">${isPositive ? '‚Üë' : '‚Üì'} ${Math.abs(change)}${isRate ? 'pp' : '%'}</span>`;
            }

            function formatCancelChange(current, previous) {
                if (previous === null || previous === undefined) return '<span class="comparison-badge neutral">N/A</span>';
                const change = (current - previous).toFixed(1);
                const cls = change > 0 ? 'down' : change < 0 ? 'up' : 'neutral';
                return `<span class="comparison-badge ${cls}">${change > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change)}pp</span>`;
            }

            function updateDashboard() {
                updateMonthSelector();

                const monthSelector = document.getElementById('monthSelector');
                if (!monthSelector.value) return;

                const [year, month] = monthSelector.value.split('-').map(Number);
                const current = getMonthData(year, month);
                if (!current) return;

                const lastMonthInfo = getLastMonth(year, month);
                const lastMonth = getMonthData(lastMonthInfo.year, lastMonthInfo.month);
                const lastYear = getMonthData(year - 1, month);

                document.getElementById('totalOrders').textContent = fmt(current.total_orders);
                document.getElementById('deliveryRate').textContent = (current.delivery_rate || 0) + '%';
                document.getElementById('cancelRate').textContent = (current.cancel_rate || 0) + '%';

                document.getElementById('totalVsLastMonth').innerHTML = formatChange(current.total_orders, lastMonth?.total_orders);
                document.getElementById('totalVsLastYear').innerHTML = formatChange(current.total_orders, lastYear?.total_orders);
                document.getElementById('deliveryVsLastMonth').innerHTML = formatChange(current.delivery_rate, lastMonth?.delivery_rate, true);
                document.getElementById('deliveryVsLastYear').innerHTML = formatChange(current.delivery_rate, lastYear?.delivery_rate, true);
                document.getElementById('cancelVsLastMonth').innerHTML = formatCancelChange(current.cancel_rate, lastMonth?.cancel_rate);
                document.getElementById('cancelVsLastYear').innerHTML = formatCancelChange(current.cancel_rate, lastYear?.cancel_rate);

                document.getElementById('deliveredPct').textContent = `${current.delivery_rate || 0}%`;
                document.getElementById('deliveredCount').textContent = `(${fmt(current.delivered)})`;
                document.getElementById('cancelledPct').textContent = `${current.cancel_rate || 0}%`;
                document.getElementById('cancelledCount').textContent = `(${fmt(current.cancelled)})`;

                const returnRate = current.total_orders ? (current.returned / current.total_orders * 100).toFixed(1) : 0;
                const failedRate = current.total_orders ? (current.failed / current.total_orders * 100).toFixed(1) : 0;
                document.getElementById('returnedPct').textContent = `${returnRate}%`;
                document.getElementById('returnedCount').textContent = `(${fmt(current.returned)})`;
                document.getElementById('failedPct').textContent = `${failedRate}%`;
                document.getElementById('failedCount').textContent = `(${fmt(current.failed)})`;

                updateTrendChart(year, month);
                updateComparisonChart(year, month, lastMonth, lastYear);
            }

            function updateTrendChart(currentYear, currentMonth) {
                const data = getFilteredData().sort((a, b) => a.Year !== b.Year ? a.Year - b.Year : a.Month - b.Month);
                const currentIdx = data.findIndex(d => d.Year === currentYear && d.Month === currentMonth);
                const trendData = data.slice(Math.max(0, currentIdx - 11), currentIdx + 1);
                const labels = trendData.map(d => `${monthNames[d.Month]} ${d.Year}`);

                Plotly.newPlot('trendChart', [
                    {x: labels, y: trendData.map(d => d.total_orders), type: 'scatter', mode: 'lines+markers', name: 'Total', line: {color: '#00d4aa', width: 3}, fill: 'tozeroy', fillcolor: 'rgba(0,212,170,0.1)'},
                    {x: labels, y: trendData.map(d => d.delivered), type: 'scatter', mode: 'lines+markers', name: 'Delivered', line: {color: '#4ecdc4', width: 2, dash: 'dot'}}
                ], {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: {color: '#888'}, margin: {t: 20, r: 20, b: 60, l: 60},
                    xaxis: {gridcolor: 'rgba(255,255,255,0.1)', tickangle: -45},
                    yaxis: {gridcolor: 'rgba(255,255,255,0.1)'},
                    legend: {orientation: 'h', y: 1.1}
                }, {responsive: true});
            }

            function updateComparisonChart(year, month, lastMonth, lastYear) {
                const current = getMonthData(year, month);
                const cats = ['Total', 'Delivered', 'Cancelled', 'Returned'];
                const curVals = [current.total_orders, current.delivered, current.cancelled, current.returned];
                const lmVals = lastMonth ? [lastMonth.total_orders, lastMonth.delivered, lastMonth.cancelled, lastMonth.returned] : [0,0,0,0];
                const lyVals = lastYear ? [lastYear.total_orders, lastYear.delivered, lastYear.cancelled, lastYear.returned] : [0,0,0,0];

                Plotly.newPlot('comparisonChart', [
                    {x: cats, y: curVals, type: 'bar', name: `${monthNames[month]} ${year}`, marker: {color: '#00d4aa'}},
                    {x: cats, y: lmVals, type: 'bar', name: lastMonth ? `${monthNames[lastMonth.Month]} ${lastMonth.Year}` : 'Last Month', marker: {color: '#4a90a4'}},
                    {x: cats, y: lyVals, type: 'bar', name: `${monthNames[month]} ${year-1}`, marker: {color: '#8b5cf6'}}
                ], {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: {color: '#888'}, margin: {t: 20, r: 20, b: 40, l: 60},
                    barmode: 'group', legend: {orientation: 'h', y: 1.15},
                    yaxis: {gridcolor: 'rgba(255,255,255,0.1)'}
                }, {responsive: true});
            }

            document.getElementById('monthSelector').onchange = updateDashboard;
            updateDashboard();
        </script>
    </body>
</html>
